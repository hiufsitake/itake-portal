<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <title>ITAKE | PO Manager</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .input-box { border: 2px solid #f1f5f9; padding: 1rem; border-radius: 1.25rem; background: #f8fafc; font-weight: 700; width: 100%; outline: none; transition: all 0.2s; }
        .input-box:focus { border-color: #10b981; background: white; }
        .tab-active { background: #10b981; color: white; box-shadow: 0 10px 15px -3px rgba(16, 185, 129, 0.3); }
        .sst-hidden { display: none !important; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen pb-24 text-slate-900 font-medium">

    <nav class="bg-[#0f172a] text-white p-5 sticky top-0 z-50 shadow-xl border-b-2 border-emerald-600">
        <div class="max-w-4xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-3">
                <a href="../index.html" class="p-2 hover:bg-slate-800 rounded-lg text-slate-400 hover:text-white transition-all">
                    <i data-lucide="arrow-left" class="w-5 h-5"></i>
                </a>
                <h1 class="font-black italic text-xl uppercase tracking-tighter leading-none">ITAKE <span class="text-emerald-500 text-2xl uppercase">PO</span></h1>
            </div>
            <div class="flex bg-slate-800 p-1 rounded-xl gap-1">
                <button onclick="switchTab('create')" id="nav-create" class="px-4 py-2 rounded-lg text-[10px] font-bold tab-active uppercase">Create</button>
                <button onclick="switchTab('history')" id="nav-history" class="px-4 py-2 rounded-lg text-[10px] font-bold text-slate-400 uppercase">History</button>
            </div>
        </div>
    </nav>

    <main class="max-w-4xl mx-auto p-4 mt-6">
        <div id="tab-create">
            <form id="po-form" class="space-y-6">
                <input type="hidden" id="edit-id">
                
                <section class="bg-white p-6 rounded-[2.5rem] shadow-sm border space-y-4">
                    <h2 class="font-black uppercase text-[10px] tracking-widest text-slate-400">Issuing Company</h2>
                    <select id="issuing-company" onchange="toggleSSTFields()" class="input-box text-emerald-600 uppercase italic">
                        <option value="SOLUTIONS">ITAKE SOLUTIONS SDN. BHD.</option>
                        <option value="OPTIMIZATION">ITAKE OPTIMIZATION SDN. BHD.</option>
                        <option value="ENERGY">ITAKE ENERGY SDN. BHD.</option>
                    </select>
                </section>

                <div class="grid md:grid-cols-2 gap-6">
                    <section class="bg-white p-6 rounded-[2.5rem] shadow-sm border space-y-4">
                        <h2 class="font-black uppercase text-[10px] tracking-widest text-slate-400">PO Details</h2>
                        <input type="text" id="po-no" class="input-box bg-slate-100 text-slate-500" readonly required>
                        <input type="date" id="po-date" class="input-box" readonly>
                        <input type="text" id="approved-by" placeholder="Approved By" class="input-box" required>
                    </section>
                    <section class="bg-white p-6 rounded-[2.5rem] shadow-sm border space-y-4">
                        <h2 class="font-black uppercase text-[10px] tracking-widest text-slate-400">Supplier Details</h2>
                        <input type="text" id="supplier-name" placeholder="Supplier Name" class="input-box" required>
                        <textarea id="supplier-address" placeholder="Supplier Address" class="input-box" rows="2" required></textarea>
                    </section>
                </div>

                <section class="bg-white p-6 rounded-[2.5rem] shadow-sm border space-y-4">
                    <div class="flex justify-between items-center mb-2">
                        <h2 class="font-black uppercase text-[10px] tracking-widest text-slate-400">Itemized List</h2>
                        <button type="button" onclick="addItemRow()" class="bg-emerald-50 text-emerald-600 px-4 py-2 rounded-xl font-black text-[10px] uppercase flex items-center gap-1 shadow-sm"><i data-lucide="plus-circle" class="w-3 h-3"></i> Add Item</button>
                    </div>
                    
                    <div id="items-list" class="space-y-3"></div>
                </section>

                <div class="flex gap-4">
                    <button type="submit" class="flex-1 bg-emerald-600 text-white font-black p-6 rounded-[2rem] shadow-xl uppercase tracking-widest text-xs italic flex items-center justify-center gap-3"><i data-lucide="save" class="w-5 h-5"></i> <span id="submit-text">Save & Print PO</span></button>
                    <button type="button" id="cancel-edit" onclick="resetForm()" class="hidden bg-slate-200 text-slate-600 font-black px-8 rounded-[2rem] uppercase text-[10px]">Cancel Edit</button>
                </div>
            </form>
        </div>

        <div id="tab-history" class="hidden space-y-4">
            <div id="history-list" class="space-y-3"></div>
        </div>
    </main>

    <script>
        const SUPABASE_URL = 'https://bszndksgqdvrblvtsmmr.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJzem5ka3NncWR2cmJsdnRzbW1yIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYxMDUyNDksImV4cCI6MjA4MTY4MTI0OX0.mu6oEib2o8KKtWgnk8zHCx-nmbHHNkfnc_qVE-Ua5yg';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const LOGO_FILENAME = "logo.jpg"; 
        const HQ_ADDR = "Unit 906-3-04, Soon Hup Tower (2nd Floor), Jalan Maju, 98000 Miri, Sarawak, Malaysia.";
        const HQ_TEL = "+6084-309 048 (Miri Office)";

        const CO_DATA = {
            'SOLUTIONS': { name: 'ITAKE SOLUTIONS SDN. BHD.', reg: '201701003049 (1217199-M)', email: 'itakessb@gmail.com', sst: true },
            'OPTIMIZATION': { name: 'ITAKE OPTIMIZATION SDN. BHD.', reg: '201901030485 (1339815-V)', email: 'itakeosb@gmail.com', sst: false },
            'ENERGY': { name: 'ITAKE ENERGY SDN. BHD.', reg: '202501050305 (1651713-K)', email: 'itakeenergy@gmail.com', sst: false }
        };

        let currentPOs = [];

        async function fetchPOs() {
            const { data } = await supabaseClient.from('po_logs').select('*').order('created_at', { ascending: false });
            currentPOs = data || [];
            document.getElementById('history-list').innerHTML = currentPOs.map(po => `
                <div class="bg-white p-5 rounded-[2rem] border shadow-sm flex justify-between items-center">
                    <div>
                        <p class="text-[8px] font-black text-emerald-600 uppercase italic">${po.company_name}</p>
                        <h3 class="font-black text-slate-800 text-sm">${po.po_number}</h3>
                        <p class="text-[10px] font-bold text-slate-400 uppercase">${po.supplier_name}</p>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="text-right mr-4"><p class="text-[8px] font-black text-slate-300 uppercase">Total</p><p class="font-black text-slate-900">RM ${po.total_amount.toFixed(2)}</p></div>
                        <button onclick="reprintPO('${po.id}')" class="p-3 bg-emerald-50 text-emerald-600 rounded-xl hover:bg-emerald-600 hover:text-white transition-all"><i data-lucide="printer" class="w-4 h-4"></i></button>
                        <button onclick="loadForEdit('${po.id}')" class="p-3 bg-blue-50 text-blue-500 rounded-xl hover:bg-blue-500 hover:text-white transition-all"><i data-lucide="edit-3" class="w-4 h-4"></i></button>
                        <button onclick="deletePO('${po.id}')" class="p-3 bg-red-50 text-red-400 rounded-xl hover:bg-red-500 hover:text-white transition-all"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </div>
                </div>
            `).join('') || '<div class="text-center p-10 text-slate-300 italic">No records.</div>';
            lucide.createIcons();
        }

        async function createPDF(data) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const info = CO_DATA[data.company_key];

            try { 
                const img = new Image();
                img.src = LOGO_FILENAME;
                await new Promise(resolve => { img.onload = resolve; img.onerror = resolve; });
                if(img.complete && img.naturalWidth !== 0) doc.addImage(img, 'JPEG', 14, 10, 40, 22); 
            } catch(e) {}

            doc.setFont("helvetica", "bold").setFontSize(16).text(info.name, 58, 18);
            doc.setFontSize(8).setFont("helvetica", "normal");
            doc.text(`Company Reg. No.: ${info.reg}`, 58, 23);
            const wrappedAddr = doc.splitTextToSize(HQ_ADDR, 130);
            doc.text(wrappedAddr, 58, 28);
            const addrHeight = wrappedAddr.length * 4;
            doc.text(`Phone: ${HQ_TEL} | Email: ${info.email} | Web: www.itakeosb.com`, 58, 28 + addrHeight);
            doc.setDrawColor(16, 185, 129).setLineWidth(0.5).line(14, 32 + addrHeight, 196, 32 + addrHeight);

            const poY = 40 + addrHeight;
            doc.setFontSize(18).setFont("helvetica", "bold").text("PURCHASE ORDER", 14, poY);
            doc.setFontSize(10).text(`PO Number: ${data.po_number}`, 130, poY);
            doc.text(`Date: ${data.po_date}`, 130, poY + 6);

            doc.text("Supplier:", 14, poY + 16);
            doc.setFont("helvetica", "normal").text(data.supplier_name, 35, poY + 16);
            doc.setFont("helvetica", "bold").text("Address:", 14, poY + 22);
            doc.setFont("helvetica", "normal").text(doc.splitTextToSize(data.supplier_address, 80), 35, poY + 22);

            const head = info.sst ? [['No.', 'Item Description', 'Qty', 'Unit', 'Price', 'SST%', 'SST RM', 'Total']] : [['No.', 'Description', 'Qty', 'Unit', 'Price', 'Total']];
            const body = data.items.map((i, idx) => {
                const amt = i.qty * i.price;
                const sstVal = amt * (i.sst/100);
                return info.sst ? [idx+1, i.desc, i.qty, i.unit, i.price.toFixed(2), i.sst+"%", sstVal.toFixed(2), (amt+sstVal).toFixed(2)] : [idx+1, i.desc, i.qty, i.unit, i.price.toFixed(2), amt.toFixed(2)];
            });

            doc.autoTable({ startY: poY + 35, head, body, theme: 'grid', headStyles: { fillColor: [15, 23, 42] }, styles: { fontSize: 8 } });
            doc.setFont("helvetica", "bold").text(`TOTAL (RM): ${data.total_amount.toFixed(2)}`, 196, doc.lastAutoTable.finalY + 10, { align: 'right' });
            doc.setFontSize(10).text("Approved by:", 140, doc.lastAutoTable.finalY + 30);
            doc.line(140, doc.lastAutoTable.finalY + 45, 190, doc.lastAutoTable.finalY + 45);
            doc.text(data.approved_by, 140, doc.lastAutoTable.finalY + 50);
            doc.save(`${data.po_number}.pdf`);
        }

        async function reprintPO(id) { const po = currentPOs.find(p => p.id === id); if(po) createPDF(po); }

        async function setAutoPONumber() {
            if(document.getElementById('edit-id').value) return;
            const now = new Date();
            const dateStr = `${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}`;
            const { count } = await supabaseClient.from('po_logs').select('*', { count: 'exact', head: true }).gte('created_at', `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-01`);
            document.getElementById('po-no').value = `PO-${dateStr}-${String((count || 0) + 1).padStart(2, '0')}`;
            document.getElementById('po-date').value = now.toISOString().split('T')[0];
        }

        function addItemRow(data = {}) {
            const container = document.getElementById('items-list');
            const div = document.createElement('div');
            div.className = 'item-row grid grid-cols-12 gap-2 bg-slate-50 p-3 rounded-2xl border border-slate-100 items-center';
            div.innerHTML = `
                <input type="text" placeholder="Description" class="col-span-5 bg-transparent font-bold text-[11px] outline-none" value="${data.desc || ''}" required>
                <input type="number" placeholder="Qty" class="col-span-1 bg-transparent font-bold text-[11px] outline-none text-center" value="${data.qty || ''}" required>
                <input type="text" placeholder="Unit" class="col-span-1 bg-transparent font-bold text-[11px] outline-none text-center" value="${data.unit || ''}">
                <input type="number" step="0.01" placeholder="Price" class="col-span-2 bg-transparent font-bold text-[11px] outline-none text-center" value="${data.price || ''}" required>
                <input type="number" step="0.1" placeholder="%" class="col-span-1 bg-transparent font-bold text-[11px] outline-none text-center sst-col ${CO_DATA[document.getElementById('issuing-company').value].sst ? '' : 'sst-hidden'}" value="${data.sst || ''}">
                <button type="button" onclick="this.parentElement.remove()" class="col-span-2 text-red-300 hover:text-red-600 flex justify-center"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
            `;
            container.appendChild(div);
            lucide.createIcons();
        }

        function toggleSSTFields() {
            const isSST = CO_DATA[document.getElementById('issuing-company').value].sst;
            document.querySelectorAll('.sst-col').forEach(el => el.classList.toggle('sst-hidden', !isSST));
        }

        function switchTab(tab) {
            document.getElementById('tab-create').classList.toggle('hidden', tab !== 'create');
            document.getElementById('tab-history').classList.toggle('hidden', tab !== 'history');
            document.getElementById('nav-create').className = `px-4 py-2 rounded-lg text-[10px] font-bold uppercase transition-all ${tab === 'create' ? 'tab-active' : 'text-slate-400'}`;
            document.getElementById('nav-history').className = `px-4 py-2 rounded-lg text-[10px] font-bold uppercase transition-all ${tab === 'history' ? 'tab-active' : 'text-slate-400'}`;
            if(tab === 'history') fetchPOs();
            lucide.createIcons();
        }

        function loadForEdit(id) {
            const po = currentPOs.find(p => p.id === id);
            if(!po) return;
            switchTab('create');
            document.getElementById('edit-id').value = po.id;
            document.getElementById('issuing-company').value = po.company_key;
            document.getElementById('po-no').value = po.po_number;
            document.getElementById('po-date').value = po.po_date;
            document.getElementById('supplier-name').value = po.supplier_name;
            document.getElementById('supplier-address').value = po.supplier_address;
            document.getElementById('approved-by').value = po.approved_by;
            document.getElementById('items-list').innerHTML = '';
            po.items.forEach(item => addItemRow(item));
            document.getElementById('submit-text').innerText = "Update PO";
            document.getElementById('cancel-edit').classList.remove('hidden');
            toggleSSTFields();
        }

        async function deletePO(id) { if(confirm("Delete record?")) { await supabaseClient.from('po_logs').delete().eq('id', id); fetchPOs(); } }

        function resetForm() {
            document.getElementById('po-form').reset();
            document.getElementById('items-list').innerHTML = '';
            document.getElementById('edit-id').value = '';
            document.getElementById('submit-text').innerText = "Save & Print PO";
            document.getElementById('cancel-edit').classList.add('hidden');
            addItemRow();
            setAutoPONumber();
        }

        document.getElementById('po-form').onsubmit = async function(e) {
            e.preventDefault();
            const items = [];
            let sub = 0, tax = 0;
            document.querySelectorAll('.item-row').forEach(row => {
                const f = row.querySelectorAll('input');
                const qty = parseFloat(f[1].value), pr = parseFloat(f[3].value), amt = qty * pr;
                const sstP = parseFloat(f[4].value || 0);
                sub += amt; tax += (amt * sstP / 100);
                items.push({ desc: f[0].value, qty, unit: f[2].value, price: pr, sst: sstP });
            });

            const payload = {
                po_number: document.getElementById('po-no').value,
                po_date: document.getElementById('po-date').value,
                company_key: document.getElementById('issuing-company').value,
                company_name: CO_DATA[document.getElementById('issuing-company').value].name,
                supplier_name: document.getElementById('supplier-name').value,
                supplier_address: document.getElementById('supplier-address').value,
                approved_by: document.getElementById('approved-by').value,
                items: items,
                total_amount: sub + tax
            };

            const editId = document.getElementById('edit-id').value;
            const { error } = editId ? await supabaseClient.from('po_logs').update(payload).eq('id', editId) : await supabaseClient.from('po_logs').insert(payload);
            
            if(!error) { createPDF(payload); resetForm(); alert("PO Processed Successfully"); } else { alert("Error: " + error.message); }
        };

        addItemRow();
        setAutoPONumber();
    </script>
</body>
</html>