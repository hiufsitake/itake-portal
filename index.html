<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="ilogo.PNG" type="image/png"> 
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <title>ITAKE | Portal</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        .input-box { 
            border: 2px solid #f1f5f9; 
            padding: 1rem; 
            border-radius: 1.25rem; 
            background: #f8fafc; 
            font-weight: 700; 
            width: 100%; 
            outline: none; 
            transition: all 0.2s; 
        }
        .input-box:focus { border-color: #10b981; background: white; }

        .nav-card { 
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); 
            border: 2px solid #f8fafc;
            background: #ffffff;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
        }
        .nav-card:hover { 
            border-color: #10b981; 
            transform: translateY(-3px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
    </style>
</head>
<body class="bg-white min-h-screen flex flex-col items-center justify-center p-6">

    <div class="w-full max-w-md space-y-12 text-center">
        
        <div class="flex flex-col items-center">
            <img src="logo.jpg" alt="ITAKE Logo" class="w-64 md:w-80 h-auto object-contain mb-4">
            <div class="h-1 w-12 bg-emerald-500 rounded-full mb-2"></div>
            <p class="text-[11px] font-black uppercase tracking-[0.5em] text-slate-400">Operations Portal</p>
        </div>

        <div id="auth-view" class="space-y-6">
            <div class="space-y-2">
                <h2 id="auth-title" class="text-xl font-black text-slate-800">Welcome</h2>
                <p id="auth-subtitle" class="text-xs font-bold text-slate-400">Please login to access the system.</p>
            </div>

            <div class="space-y-4">
                <input type="email" id="email" placeholder="Email Address" class="input-box" required>
                <input type="password" id="password" placeholder="Password" class="input-box" required>
            </div>

            <div class="flex justify-between items-center px-1">
                <button onclick="toggleAuthMode()" id="toggle-auth-btn" class="text-[10px] font-bold text-slate-400 hover:text-emerald-600 uppercase tracking-widest transition-colors">Create Account</button>
                <button onclick="handleForgotPassword()" id="forgot-pw-btn" class="text-[10px] font-bold text-slate-400 hover:text-emerald-600 uppercase tracking-widest transition-colors">Forgot Password?</button>
            </div>

            <button onclick="handleAuth()" id="submit-btn" class="w-full bg-slate-900 text-white font-black p-5 rounded-[2rem] shadow-xl uppercase tracking-widest text-xs hover:bg-emerald-600 transition-all">
                Login
            </button>
            
            <p id="error-msg" class="text-red-500 text-xs font-bold hidden bg-red-50 p-3 rounded-xl"></p>
            <p id="success-msg" class="text-emerald-600 text-xs font-bold hidden bg-emerald-50 p-3 rounded-xl"></p>
        </div>

        <div id="reset-view" class="hidden space-y-6">
            <div class="space-y-2">
                <h2 class="text-xl font-black text-slate-800">Reset Password</h2>
                <p class="text-xs font-bold text-slate-400">Enter your new password below.</p>
            </div>

            <input type="password" id="new-password" placeholder="New Password" class="input-box" required>

            <button onclick="handleUpdatePassword()" id="update-pw-btn" class="w-full bg-emerald-600 text-white font-black p-5 rounded-[2rem] shadow-xl uppercase tracking-widest text-xs hover:bg-emerald-700 transition-all">
                Update Password
            </button>
        </div>

        <div id="dashboard-view" class="hidden space-y-6">
            <div class="grid gap-5">
                <a href="po/index.html" class="nav-card p-6 rounded-[2.25rem] flex items-center gap-6">
                    <div class="bg-emerald-500 text-white p-4 rounded-2xl shadow-lg shadow-emerald-200">
                        <i data-lucide="shopping-cart" class="w-6 h-6"></i>
                    </div>
                    <div class="text-left">
                        <h2 class="font-black uppercase italic text-slate-800 text-lg tracking-tight">PO System</h2>
                        <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Procurement & SST</p>
                    </div>
                </a>

                <a href="cashclaim/index.html" class="nav-card p-6 rounded-[2.25rem] flex items-center gap-6">
                    <div class="bg-blue-500 text-white p-4 rounded-2xl shadow-lg shadow-blue-200">
                        <i data-lucide="wallet" class="w-6 h-6"></i>
                    </div>
                    <div class="text-left">
                        <h2 class="font-black uppercase italic text-slate-800 text-lg tracking-tight">Cash Claim</h2>
                        <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Expenses & Claims</p>
                    </div>
                </a>

                <a href="leave/index.html" class="nav-card p-6 rounded-[2.25rem] flex items-center gap-6">
                    <div class="bg-slate-900 text-white p-4 rounded-2xl shadow-lg shadow-slate-200">
                        <i data-lucide="calendar" class="w-6 h-6"></i>
                    </div>
                    <div class="text-left">
                        <h2 class="font-black uppercase italic text-slate-800 text-lg tracking-tight">Leave System</h2>
                        <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Staff Attendance</p>
                    </div>
                </a>
            </div>

            <button onclick="handleLogout()" class="text-[10px] font-bold text-red-300 hover:text-red-500 uppercase tracking-widest transition-colors flex items-center justify-center gap-2 mx-auto pt-4">
                <i data-lucide="log-out" class="w-4 h-4"></i> Sign Out
            </button>
        </div>

        <footer class="pt-10">
            <p class="text-[9px] font-black uppercase tracking-[0.6em] text-slate-300">
                ITAKE GROUP
            </p>
        </footer>
    </div>

    <script>
        const SUPABASE_URL = 'https://bszndksgqdvrblvtsmmr.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJzem5ka3NncWR2cmJsdnRzbW1yIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYxMDUyNDksImV4cCI6MjA4MTY4MTI0OX0.mu6oEib2o8KKtWgnk8zHCx-nmbHHNkfnc_qVE-Ua5yg';
        
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let isLoginMode = true;

        supabaseClient.auth.onAuthStateChange((event, session) => {
            if (event === 'SIGNED_IN') {
                showDashboard();
            } else if (event === 'SIGNED_OUT') {
                showAuth();
            } else if (event === 'PASSWORD_RECOVERY') {
                showResetPassword();
            }
        });

        async function checkSession() {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (session) showDashboard();
            else showAuth();
        }

        function showDashboard() {
            hideAll();
            document.getElementById('dashboard-view').classList.remove('hidden');
        }

        function showAuth() {
            hideAll();
            document.getElementById('auth-view').classList.remove('hidden');
        }

        function showResetPassword() {
            hideAll();
            document.getElementById('reset-view').classList.remove('hidden');
        }

        function hideAll() {
            document.getElementById('auth-view').classList.add('hidden');
            document.getElementById('dashboard-view').classList.add('hidden');
            document.getElementById('reset-view').classList.add('hidden');
        }

        function toggleAuthMode() {
            isLoginMode = !isLoginMode;
            const title = document.getElementById('auth-title');
            const sub = document.getElementById('auth-subtitle');
            const btn = document.getElementById('submit-btn');
            const toggleBtn = document.getElementById('toggle-auth-btn');
            const forgotBtn = document.getElementById('forgot-pw-btn');
            
            document.getElementById('error-msg').classList.add('hidden');
            document.getElementById('success-msg').classList.add('hidden');

            if (isLoginMode) {
                title.innerText = "Welcome";
                sub.innerText = "Please login to access the system.";
                btn.innerText = "Login";
                toggleBtn.innerText = "Create Account";
                forgotBtn.classList.remove('hidden');
            } else {
                title.innerText = "New Account";
                sub.innerText = "Enter details to register.";
                btn.innerText = "Sign Up";
                toggleBtn.innerText = "Back to Login";
                forgotBtn.classList.add('hidden');
            }
        }

        async function handleAuth() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const btn = document.getElementById('submit-btn');
            const errMsg = document.getElementById('error-msg');
            const successMsg = document.getElementById('success-msg');

            if (!email || !password) {
                errMsg.innerText = "Please enter both email and password.";
                errMsg.classList.remove('hidden');
                return;
            }

            errMsg.classList.add('hidden');
            successMsg.classList.add('hidden');
            const originalText = btn.innerText;
            btn.innerHTML = '<span class="animate-pulse">Processing...</span>';

            if (isLoginMode) {
                const { error } = await supabaseClient.auth.signInWithPassword({ email, password });
                if (error) {
                    errMsg.innerText = error.message;
                    errMsg.classList.remove('hidden');
                    btn.innerText = originalText;
                }
            } else {
                const { error } = await supabaseClient.auth.signUp({ email, password });
                if (error) {
                    errMsg.innerText = error.message;
                    errMsg.classList.remove('hidden');
                } else {
                    successMsg.innerText = "Account created! Please check your email.";
                    successMsg.classList.remove('hidden');
                }
                btn.innerText = originalText;
            }
        }

        async function handleForgotPassword() {
            const email = document.getElementById('email').value;
            if (!email) {
                alert("Please enter your email address in the box first.");
                return;
            }
            // Uses window.location.href to redirect back to this page
            const { error } = await supabaseClient.auth.resetPasswordForEmail(email, {
                redirectTo: window.location.href, 
            });
            if (error) alert(error.message);
            else alert("Password reset link sent! Check your email.");
        }

        async function handleUpdatePassword() {
            const newPassword = document.getElementById('new-password').value;
            if(!newPassword) return alert("Enter a new password");

            const { error } = await supabaseClient.auth.updateUser({ password: newPassword });
            if(error) {
                alert("Error: " + error.message);
            } else {
                alert("Password updated successfully!");
                showDashboard();
            }
        }

        async function handleLogout() {
            await supabaseClient.auth.signOut();
        }

        lucide.createIcons();
        checkSession();
    </script>
</body>
</html>